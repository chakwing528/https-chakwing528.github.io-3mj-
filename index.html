<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>ä¸‰äººéº»é›€ç´¯è¨ˆè¨ˆç®—æ©Ÿ (å„ªåŒ–ç‰ˆ)</title>
<style>
    body { font-family: "Microsoft JhengHei", Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; background: #f0f2f5; color: #333; }
    h2, h4 { text-align: center; margin-bottom: 10px; }
    input { padding: 10px; font-size: 16px; width: 80px; text-align: center; border: 1px solid #ddd; border-radius: 4px; }
    button { margin: 5px; padding: 12px 15px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; background: #fff; transition: all 0.2s; }
    button:hover { background-color: #eee; }
    button:active { transform: scale(0.98); }
    
    #controls button { min-width: 60px; }
    
    .container { margin-top: 20px; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    
    .stats-table, .log-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .stats-table td, .stats-table th, .log-table td, .log-table th { border: 1px solid #eee; padding: 10px; text-align: center; font-size: 16px; }
    .stats-table th { background-color: #f8f9fa; }
    
    /* ç‹€æ…‹é¡è‰² */
    .highlight-winner { background-color: #d4edda !important; border-color: #c3e6cb !important; color: #155724; font-weight: bold; }
    .highlight-loser { background-color: #f8d7da !important; border-color: #f5c6cb !important; color: #721c24; font-weight: bold; }
    .active-btn { background-color: #cce5ff !important; border-color: #b8daff !important; color: #004085; font-weight: bold; }
    
    .positive { color: green; font-weight: bold; }
    .negative { color: red; font-weight: bold; }
    
    .disabled-section { opacity: 0.3; pointer-events: none; }
    
    .action-btn { width: 100%; background-color: #28a745; color: white; border: none; font-size: 18px; font-weight: bold; padding: 15px; margin: 20px 0 0 0; }
    .action-btn:hover { background-color: #218838; }
    
    .reset-btn { background-color: #dc3545; color: white; border: none; font-size: 14px; padding: 8px 15px; float: right; }
    .reset-btn:hover { background-color: #c82333; }
</style>
</head>
<body>

<h2>ğŸ€„ ä¸‰äººéº»é›€ç´¯è¨ˆè¨ˆç®—æ©Ÿ</h2>

<div class="container">
    <button class="reset-btn" onclick="resetAll()">âš ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™</button>
    <h4>ç©å®¶åç¨±è¨­å®š</h4>
    <div style="text-align: center;">
        <input type="text" id="playerA" placeholder="ç©å®¶A" value="A">
        <input type="text" id="playerB" placeholder="ç©å®¶B" value="B">
        <input type="text" id="playerC" placeholder="ç©å®¶C" value="C">
        <button onclick="updatePlayerNames()">æ›´æ–°åç¨±</button>
    </div>
</div>

<div class="container" id="controls">
    <h4>1. å‹å‡ºæ–¹å¼</h4>
    <div id="methodButtons" style="text-align: center;"></div>

    <h4>2. é¸æ“‡å‹å®¶</h4>
    <div id="winnerButtons" style="text-align: center;"></div>

    <div id="loserSection">
        <h4>3. é¸æ“‡è¼¸å®¶ (åŒ…ç‰Œ)</h4>
        <div id="loserButtons" style="text-align: center;"></div>
    </div>

    <h4>4. ç•ªæ•¸</h4>
    <div id="fanButtons" style="text-align: center;"></div>

    <button class="action-btn" onclick="addResult()">è¨˜éŒ„æ­¤å ´</button>
</div>

<div class="container">
    <h4>ç›®å‰æˆ°æ³</h4>
    <div id="summary" style="font-size: 18px; line-height: 1.6; text-align: center;"></div>
    <div id="totalGames" style="text-align: center; color: #666; margin-top: 10px;"></div>
</div>

<div class="container">
    <h4>çµ±è¨ˆæ•¸æ“š</h4>
    <div id="stats"></div>
</div>

<div class="container" id="log">
    <h4>è©³ç´°ç´€éŒ„</h4>
</div>

<script>
let players = ["A", "B", "C"];
let total = {};
let stats = {};
let winner = "";
let loser = "";
let selectedFan = 3;
let selectedMethod = "å‡ºè¡"; // é è¨­
let records = [];

// å®šç¾©ç•ªæ•¸èˆ‡ç±Œç¢¼è¡¨ (æ‚¨å¯ä»¥æ ¹æ“šéœ€æ±‚ä¿®æ”¹æ­¤è¡¨)
const priceTable = {
    3: { chong: 2, zimo: 2 },
    4: { chong: 4, zimo: 3 },
    5: { chong: 6, zimo: 5 },
    6: { chong: 8, zimo: 6 },
    7: { chong: 12, zimo: 9 },
    8: { chong: 16, zimo: 12 },
    9: { chong: 24, zimo: 18 },
    10: { chong: 32, zimo: 24 }
};

function createStats() {
    return { chongTotal: 0, zimoTotal: 0 };
}

function saveData() {
    const data = { players, total, stats, records };
    localStorage.setItem("mahjongData_v2", JSON.stringify(data));
}

function loadData() {
    const data = JSON.parse(localStorage.getItem("mahjongData_v2"));
    if (data) {
        players = data.players;
        total = data.total;
        stats = data.stats;
        records = data.records;
        document.getElementById("playerA").value = players[0];
        document.getElementById("playerB").value = players[1];
        document.getElementById("playerC").value = players[2];
    } else {
        initGame();
    }
}

function initGame() {
    total = {};
    stats = {};
    players.forEach(p => {
        total[p] = 0;
        stats[p] = createStats();
    });
    records = [];
}

function resetAll() {
    if(confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ç´€éŒ„ä¸¦é‡ç½®å—ï¼Ÿ")) {
        localStorage.removeItem("mahjongData_v2");
        initGame();
        updatePlayerNames();
        alert("å·²é‡ç½®ï¼");
    }
}

function updatePlayerNames() {
    // æ›´æ–°åç¨±é™£åˆ—
    const newNames = [
        document.getElementById("playerA").value || "A",
        document.getElementById("playerB").value || "B",
        document.getElementById("playerC").value || "C"
    ];
    
    // å¦‚æœæ˜¯ä¸­é€”æ”¹åï¼Œéœ€è¦é·ç§»æ•¸æ“š
    if (players[0] !== newNames[0] || players[1] !== newNames[1] || players[2] !== newNames[2]) {
        let newTotal = {};
        let newStats = {};
        
        newNames.forEach((newName, i) => {
            let oldName = players[i];
            newTotal[newName] = total[oldName] || 0;
            newStats[newName] = stats[oldName] || createStats();
        });
        
        players = newNames;
        total = newTotal;
        stats = newStats;
    }

    renderControls();
    updateUI();
    saveData();
}

function renderControls() {
    const winnerDiv = document.getElementById("winnerButtons");
    const loserDiv = document.getElementById("loserButtons");
    winnerDiv.innerHTML = "";
    loserDiv.innerHTML = "";

    players.forEach(name => {
        // å‹å®¶æŒ‰éˆ•
        const btn1 = document.createElement("button");
        btn1.innerText = name;
        btn1.onclick = () => { winner = name; if(winner===loser) loser=""; highlightButtons(); };
        winnerDiv.appendChild(btn1);

        // è¼¸å®¶æŒ‰éˆ•
        const btn2 = document.createElement("button");
        btn2.innerText = name;
        btn2.onclick = () => { loser = name; if(winner===loser) winner=""; highlightButtons(); };
        loserDiv.appendChild(btn2);
    });

    renderFanButtons();
    renderMethodButtons();
    highlightButtons();
}

function renderFanButtons() {
    const fanDiv = document.getElementById("fanButtons");
    fanDiv.innerHTML = "";
    Object.keys(priceTable).forEach(fan => {
        const btn = document.createElement("button");
        btn.innerText = fan;
        btn.onclick = () => { selectedFan = parseInt(fan); highlightButtons(); };
        fanDiv.appendChild(btn);
    });
}

function renderMethodButtons() {
    const methodDiv = document.getElementById("methodButtons");
    methodDiv.innerHTML = "";
    ["å‡ºè¡", "è‡ªæ‘¸"].forEach(method => {
        const btn = document.createElement("button");
        btn.innerText = method;
        btn.onclick = () => { 
            selectedMethod = method; 
            loser = ""; // åˆ‡æ›æ¨¡å¼æ™‚æ¸…ç©ºè¼¸å®¶
            highlightButtons(); 
        };
        methodDiv.appendChild(btn);
    });
}

function highlightButtons() {
    // è™•ç†è‡ªæ‘¸æ™‚éš±è—è¼¸å®¶é¸é …
    const loserSection = document.getElementById("loserSection");
    if (selectedMethod === "è‡ªæ‘¸") {
        loserSection.classList.add("disabled-section");
        loser = ""; // è‡ªæ‘¸æ²’æœ‰ç‰¹å®šè¼¸å®¶
    } else {
        loserSection.classList.remove("disabled-section");
    }

    document.querySelectorAll("#winnerButtons button").forEach(btn => 
        btn.className = (btn.innerText === winner) ? "highlight-winner" : "");
        
    document.querySelectorAll("#loserButtons button").forEach(btn => 
        btn.className = (btn.innerText === loser) ? "highlight-loser" : "");

    document.querySelectorAll("#fanButtons button").forEach(btn => 
        btn.className = (parseInt(btn.innerText) === selectedFan) ? "active-btn" : "");
        
    document.querySelectorAll("#methodButtons button").forEach(btn => 
        btn.className = (btn.innerText === selectedMethod) ? "active-btn" : "");
}

function addResult() {
    if (!winner) return alert("è«‹é¸æ“‡å‹å‡ºç©å®¶ï¼");
    if (selectedMethod === "å‡ºè¡") {
        if (!loser) return alert("å‡ºè¡å¿…é ˆé¸æ“‡è¼¸å®¶ï¼");
        if (winner === loser) return alert("å‹å®¶èˆ‡è¼¸å®¶ä¸èƒ½ç›¸åŒï¼");
    }

    const amount = selectedMethod === "å‡ºè¡" ? priceTable[selectedFan].chong : priceTable[selectedFan].zimo;
    
    // å»ºç«‹ç´€éŒ„ç‰©ä»¶ (æ–°å¢ type æ¬„ä½ä»¥å„ªåŒ– Undo é‚è¼¯)
    const record = { 
        changes: {}, 
        fan: selectedFan, 
        winner: winner,
        loser: loser,
        type: selectedMethod 
    };
    
    players.forEach(p => record.changes[p] = 0);

    if (selectedMethod === "å‡ºè¡") {
        total[winner] += amount;
        total[loser] -= amount;
        stats[winner].chongTotal++;
        record.changes[winner] = amount;
        record.changes[loser] = -amount;
    } else {
        // è‡ªæ‘¸ï¼šå‹å®¶è´ 2ä»½ï¼Œå…¶ä»–å…©å®¶å„è¼¸ 1ä»½
        players.filter(p => p !== winner).forEach(p => {
            total[p] -= amount;
            record.changes[p] = -amount;
        });
        total[winner] += amount * 2;
        record.changes[winner] = amount * 2;
        stats[winner].zimoTotal++;
    }

    records.unshift(record); // æ–°ç´€éŒ„æ”¾åœ¨æœ€å‰é¢
    
    // é‡ç½®é¸é …æ–¹ä¾¿ä¸‹ä¸€å±€
    winner = "";
    loser = "";
    
    updateUI();
    saveData();
    highlightButtons();
}

function updateUI() {
    // ç¸½çµ
    let summaryHtml = "";
    // æ’åºé¡¯ç¤ºï¼Œåˆ†æ•¸é«˜çš„åœ¨å‰é¢
    const sortedPlayers = [...players].sort((a, b) => total[b] - total[a]);
    sortedPlayers.forEach(p => {
        const val = total[p];
        const colorClass = val >= 0 ? "positive" : "negative";
        summaryHtml += `<div>${p}ï¼š<span class="${colorClass}">${val > 0 ? "+" : ""}${val}</span></div>`;
    });
    document.getElementById("summary").innerHTML = summaryHtml;
    document.getElementById("totalGames").innerText = `ç¸½å ´æ•¸ï¼š${records.length}`;

    // çµ±è¨ˆè¡¨
    let statsHtml = `<table class="stats-table"><tr><th>ç©å®¶</th><th>å‡ºè¡</th><th>è‡ªæ‘¸</th><th>å‹ç‡</th></tr>`;
    players.forEach(p => {
        const totalWin = stats[p].chongTotal + stats[p].zimoTotal;
        const winRate = records.length ? ((totalWin / records.length) * 100).toFixed(1) + "%" : "0.0%";
        statsHtml += `<tr><td>${p}</td><td>${stats[p].chongTotal}</td><td>${stats[p].zimoTotal}</td><td>${winRate}</td></tr>`;
    });
    statsHtml += "</table>";
    document.getElementById("stats").innerHTML = statsHtml;

    // æ­·å²ç´€éŒ„
    let logHtml = `<table class="log-table"><tr><th>å›æ•¸</th><th>é¡å‹</th><th>ç•ª</th>`;
    players.forEach(p => logHtml += `<th>${p}</th>`);
    logHtml += `<th>æ“ä½œ</th></tr>`;
    
    records.forEach((r, i) => {
        const actualIndex = records.length - i; // é¡¯ç¤ºå ´æ¬¡ç·¨è™Ÿ
        const typeLabel = r.type === "å‡ºè¡" ? `<span style='color:red'>å‡ºè¡</span>` : `<span style='color:green'>è‡ªæ‘¸</span>`;
        
        logHtml += `<tr>
            <td>${actualIndex}</td>
            <td>${typeLabel}</td>
            <td>${r.fan}</td>`;
            
        players.forEach(p => {
            const val = r.changes[p];
            let displayVal = val;
            let style = "";
            if (val > 0) { displayVal = "+" + val; style = "color:green; font-weight:bold;"; }
            else if (val < 0) { style = "color:red;"; }
            else { displayVal = "-"; style="color:#ccc;"; }
            
            // æ¨™è¨˜è´å®¶æˆ–æ”¾æ§è€…
            if (p === r.winner) style += "background:#e8f5e9;";
            if (p === r.loser && r.type === "å‡ºè¡") style += "background:#ffebee;";
            
            logHtml += `<td style="${style}">${displayVal}</td>`;
        });
        logHtml += `<td><button style="padding:5px 10px; font-size:12px;" onclick="deleteRecord(${i})">æ’¤éŠ·</button></td></tr>`;
    });
    logHtml += "</table>";
    document.getElementById("log").innerHTML = logHtml;
}

function deleteRecord(index) {
    if(!confirm("ç¢ºå®šè¦æ’¤éŠ·é€™æ¢ç´€éŒ„å—ï¼Ÿåˆ†æ•¸å°‡æœƒå›æ»¾ã€‚")) return;

    const r = records[index];
    
    // å›æ»¾åˆ†æ•¸
    players.forEach(p => total[p] -= r.changes[p]);
    
    // å›æ»¾çµ±è¨ˆæ•¸æ“š
    if (r.type === "å‡ºè¡") {
        stats[r.winner].chongTotal--;
    } else {
        stats[r.winner].zimoTotal--;
    }
    
    records.splice(index, 1);
    updateUI();
    saveData();
}

// åˆå§‹åŒ–
loadData();
updatePlayerNames();
</script>

</body>
</html>
