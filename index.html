<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä¸‰éº»æˆ°ç¸¾è¨ˆç®—æ©Ÿ (å°ˆæ¥­ç‰ˆ)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
    body { font-family: "Microsoft JhengHei", Arial, sans-serif; padding: 20px; max-width: 900px; margin: auto; background: #f0f2f5; color: #333; }
    h2, h4 { text-align: center; margin-bottom: 10px; }
    input { padding: 8px; font-size: 16px; width: 70px; text-align: center; border: 1px solid #ddd; border-radius: 4px; }
    button { margin: 5px; padding: 10px 12px; font-size: 15px; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; background: #fff; transition: all 0.2s; min-width: 60px;}
    button:hover { background-color: #eee; }
    button:active { transform: scale(0.98); }
    
    .container { margin-top: 20px; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    
    /* è¡¨æ ¼æ¨£å¼å„ªåŒ– */
    .stats-table, .log-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    .stats-table td, .stats-table th, .log-table td, .log-table th { border: 1px solid #eee; padding: 8px; text-align: center; }
    .stats-table th, .log-table th { background-color: #f8f9fa; font-weight: bold; color: #555; }
    
    /* ç‹€æ…‹é¡è‰² */
    .highlight-winner { background-color: #d4edda !important; border-color: #c3e6cb !important; color: #155724; font-weight: bold; }
    .highlight-loser { background-color: #f8d7da !important; border-color: #f5c6cb !important; color: #721c24; font-weight: bold; }
    .active-btn { background-color: #cce5ff !important; border-color: #b8daff !important; color: #004085; font-weight: bold; }
    
    .positive { color: green; font-weight: bold; }
    .negative { color: red; font-weight: bold; }
    
    .disabled-section { opacity: 0.3; pointer-events: none; }
    
    .action-btn { width: 100%; background-color: #28a745; color: white; border: none; font-size: 18px; font-weight: bold; padding: 15px; margin: 20px 0 0 0; }
    .action-btn:hover { background-color: #218838; }
    
    .reset-btn { background-color: #dc3545; color: white; border: none; font-size: 14px; padding: 8px 15px; float: right; }
    .pdf-btn { background-color: #007bff; color: white; border: none; font-size: 14px; padding: 8px 15px; float: right; margin-right: 10px; }
    .pdf-btn:hover { background-color: #0069d9; }

    /* å±€æ•¸é¡¯ç¤º */
    .round-display {
        text-align: center;
        background: #343a40;
        color: #fff;
        padding: 10px;
        border-radius: 8px;
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 15px;
    }
    .dealer-badge {
        background: #ffc107;
        color: #000;
        font-size: 12px;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 5px;
        vertical-align: middle;
    }
    
    /* çµ±è¨ˆå°å­— */
    .stat-detail { font-size: 12px; color: #666; display: block; margin-top: 4px; }
</style>
</head>
<body>

<h2>ğŸ€„ ä¸‰éº»æˆ°ç¸¾è¨ˆç®—æ©Ÿ (å°ˆæ¥­ç‰ˆ)</h2>

<div class="container">
    <button class="reset-btn" onclick="resetAll()">âš ï¸ é‡ç½®</button>
    <h4>ç©å®¶è¨­å®š</h4>
    <div style="text-align: center;">
        <input type="text" id="playerA" placeholder="æ±å®¶" value="A">
        <input type="text" id="playerB" placeholder="å—å®¶" value="B">
        <input type="text" id="playerC" placeholder="è¥¿å®¶" value="C">
        <button onclick="updatePlayerNames()">æ›´æ–°åç¨±</button>
    </div>
</div>

<div class="container" id="controls">
    
    <div id="roundDisplay" class="round-display">æ± 1 å±€</div>

    <h4>1. å‹å‡ºæ–¹å¼</h4>
    <div id="methodButtons" style="text-align: center;"></div>

    <div id="winnerSection">
        <h4>2. é¸æ“‡å‹å®¶</h4>
        <div id="winnerButtons" style="text-align: center;"></div>
    </div>

    <div id="loserSection">
        <h4>3. é¸æ“‡è¼¸å®¶ / åŒ…ç‰Œè€…</h4>
        <div id="loserButtons" style="text-align: center;"></div>
    </div>

    <div id="fanSection">
        <h4>4. ç•ªæ•¸</h4>
        <div id="fanButtons" style="text-align: center;"></div>
    </div>

    <button class="action-btn" onclick="addResult()">è¨˜éŒ„æ­¤å ´</button>
</div>

<div class="container" id="statsContainer">
    <h4>ğŸ“Š å¯¦æ™‚æˆ°æ³çµ±è¨ˆ</h4>
    <div id="summary"></div>
</div>

<div class="container">
    <button class="pdf-btn" onclick="downloadPDF()">ğŸ“¥ ä¸‹è¼‰æˆ°ç¸¾è¡¨ (PDF)</button>
    <h4>ğŸ“œ è©³ç´°ç´€éŒ„</h4>
    <div id="logContent">
        <div id="log"></div>
    </div>
</div>

<script>
let players = ["A", "B", "C"];
let total = {};
let records = [];

// éŠæˆ²ç‹€æ…‹
let winner = "";
let loser = "";
let selectedFan = 3;
let selectedMethod = "å‡ºè¡"; 
// gameIndex: 0=æ±1, 1=æ±2, 2=æ±3, 3=å—1 ...
let gameIndex = 0; 
const winds = ["æ±", "å—", "è¥¿", "åŒ—"];

const priceTable = {
    3: { chong: 2, zimo: 2 },
    4: { chong: 4, zimo: 3 },
    5: { chong: 6, zimo: 5 },
    6: { chong: 8, zimo: 6 },
    7: { chong: 12, zimo: 9 },
    8: { chong: 16, zimo: 12 },
    9: { chong: 24, zimo: 18 },
    10: { chong: 32, zimo: 24 }
};

function saveData() {
    const data = { players, total, records, gameIndex };
    localStorage.setItem("mahjongData_v4", JSON.stringify(data));
}

function loadData() {
    const data = JSON.parse(localStorage.getItem("mahjongData_v4"));
    if (data) {
        players = data.players;
        total = data.total;
        records = data.records;
        gameIndex = (data.gameIndex !== undefined) ? data.gameIndex : 0;
        document.getElementById("playerA").value = players[0];
        document.getElementById("playerB").value = players[1];
        document.getElementById("playerC").value = players[2];
    } else {
        initGame();
    }
}

function initGame() {
    total = {};
    players.forEach(p => total[p] = 0);
    records = [];
    gameIndex = 0;
}

function resetAll() {
    if(confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰ç´€éŒ„å’Œåˆ†æ•¸ï¼Œé‡æ–°é–‹å§‹æ±1å±€å—ï¼Ÿ")) {
        localStorage.removeItem("mahjongData_v4");
        initGame();
        updatePlayerNames(); 
        alert("å·²é‡ç½®ï¼");
    }
}

function updatePlayerNames() {
    const newNames = [
        document.getElementById("playerA").value || "A",
        document.getElementById("playerB").value || "B",
        document.getElementById("playerC").value || "C"
    ];
    
    if (players[0] !== newNames[0] || players[1] !== newNames[1] || players[2] !== newNames[2]) {
        let newTotal = {};
        newNames.forEach((newName, i) => {
            newTotal[newName] = total[players[i]] || 0;
        });
        players = newNames;
        total = newTotal;
    }

    renderControls();
    updateUI();
    saveData();
}

function getRoundName(idx) {
    const wind = winds[Math.floor(idx / 3) % 4];
    const subRound = (idx % 3) + 1;
    return `${wind} ${subRound} å±€`;
}

function getDealer(idx) {
    return players[idx % 3];
}

// æ ¼å¼åŒ–æ™‚é–“å‡½æ•¸
function getCurrentTime() {
    const now = new Date();
    return `${now.getMonth()+1}/${now.getDate()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
}

function renderControls() {
    const winnerDiv = document.getElementById("winnerButtons");
    const loserDiv = document.getElementById("loserButtons");
    winnerDiv.innerHTML = "";
    loserDiv.innerHTML = "";

    players.forEach(name => {
        const btn1 = document.createElement("button");
        btn1.innerText = name;
        btn1.onclick = () => { winner = name; if(winner===loser) loser=""; highlightButtons(); };
        winnerDiv.appendChild(btn1);

        const btn2 = document.createElement("button");
        btn2.innerText = name;
        btn2.onclick = () => { loser = name; if(winner===loser) winner=""; highlightButtons(); };
        loserDiv.appendChild(btn2);
    });

    renderFanButtons();
    renderMethodButtons();
    highlightButtons();
}

function renderFanButtons() {
    const fanDiv = document.getElementById("fanButtons");
    fanDiv.innerHTML = "";
    Object.keys(priceTable).forEach(fan => {
        const btn = document.createElement("button");
        btn.innerText = fan;
        btn.onclick = () => { selectedFan = parseInt(fan); highlightButtons(); };
        fanDiv.appendChild(btn);
    });
}

function renderMethodButtons() {
    const methodDiv = document.getElementById("methodButtons");
    methodDiv.innerHTML = "";
    ["å‡ºè¡", "è‡ªæ‘¸", "åŒ…è‡ªæ‘¸", "æµå±€"].forEach(method => {
        const btn = document.createElement("button");
        btn.innerText = method;
        btn.onclick = () => { 
            selectedMethod = method; 
            winner = ""; loser = ""; 
            highlightButtons(); 
        };
        methodDiv.appendChild(btn);
    });
}

function highlightButtons() {
    const winnerSec = document.getElementById("winnerSection");
    const loserSec = document.getElementById("loserSection");
    const fanSec = document.getElementById("fanSection");

    winnerSec.classList.remove("disabled-section");
    loserSec.classList.remove("disabled-section");
    fanSec.classList.remove("disabled-section");

    if (selectedMethod === "æµå±€") {
        winnerSec.classList.add("disabled-section");
        loserSec.classList.add("disabled-section");
        fanSec.classList.add("disabled-section");
        winner = ""; loser = "";
    } else if (selectedMethod === "è‡ªæ‘¸") {
        loserSec.classList.add("disabled-section");
        loser = ""; 
    }

    document.querySelectorAll("#winnerButtons button").forEach(btn => 
        btn.className = (btn.innerText === winner) ? "highlight-winner" : "");
        
    document.querySelectorAll("#loserButtons button").forEach(btn => 
        btn.className = (btn.innerText === loser) ? "highlight-loser" : "");

    document.querySelectorAll("#fanButtons button").forEach(btn => 
        btn.className = (parseInt(btn.innerText) === selectedFan) ? "active-btn" : "");
        
    document.querySelectorAll("#methodButtons button").forEach(btn => 
        btn.className = (btn.innerText === selectedMethod) ? "active-btn" : "");
}

function addResult() {
    if (selectedMethod !== "æµå±€") {
        if (!winner) return alert("è«‹é¸æ“‡å‹å‡ºç©å®¶ï¼");
        if (selectedMethod === "å‡ºè¡" || selectedMethod === "åŒ…è‡ªæ‘¸") {
            if (!loser) return alert("è«‹é¸æ“‡è¼¸å®¶/åŒ…ç‰Œè€…ï¼");
            if (winner === loser) return alert("å‹å®¶èˆ‡è¼¸å®¶ä¸èƒ½ç›¸åŒï¼");
        }
    }

    const currentDealer = getDealer(gameIndex);
    let isRenchan = false; 

    // æ–°å¢ timestamp æ¬„ä½
    const record = { 
        changes: {}, 
        fan: selectedFan, 
        winner: winner,
        loser: loser,
        type: selectedMethod,
        roundStr: getRoundName(gameIndex),
        dealer: currentDealer,
        preGameIndex: gameIndex,
        timestamp: getCurrentTime() // åŠ å…¥æ™‚é–“
    };
    players.forEach(p => record.changes[p] = 0);

    if (selectedMethod === "æµå±€") {
        isRenchan = false; 
    } else {
        const amount = priceTable[selectedFan];
        
        if (selectedMethod === "å‡ºè¡") {
            total[winner] += amount.chong;
            total[loser] -= amount.chong;
            record.changes[winner] = amount.chong;
            record.changes[loser] = -amount.chong;
        } else if (selectedMethod === "è‡ªæ‘¸") {
            const zimoAmt = amount.zimo;
            players.filter(p => p !== winner).forEach(p => {
                total[p] -= zimoAmt;
                record.changes[p] = -zimoAmt;
            });
            total[winner] += zimoAmt * 2;
            record.changes[winner] = zimoAmt * 2;
        } else if (selectedMethod === "åŒ…è‡ªæ‘¸") {
            const totalWin = amount.zimo * 2;
            total[winner] += totalWin;
            total[loser] -= totalWin;
            record.changes[winner] = totalWin;
            record.changes[loser] = -totalWin;
        }

        if (winner === currentDealer) {
            isRenchan = true;
        }
    }

    if (isRenchan) {
        record.nextAction = "é€£èŠ";
    } else {
        gameIndex++; 
        record.nextAction = "éèŠ";
    }

    records.unshift(record);
    
    winner = "";
    loser = "";
    updateUI();
    saveData();
    highlightButtons();
}

// è¨ˆç®—çµ±è¨ˆæ•¸æ“šçš„å‡½æ•¸
function calculateStats() {
    let stats = {};
    players.forEach(p => {
        stats[p] = { wins: 0, dealIns: 0, zimos: 0, games: 0 };
    });
    
    // è¨ˆç®—ç¸½å±€æ•¸ (æµå±€ä¹Ÿç®—ä¸€å±€)
    const totalGames = records.length;

    records.forEach(r => {
        // åƒèˆ‡å±€æ•¸ (æ‰€æœ‰äººéƒ½+1)
        players.forEach(p => stats[p].games++);

        if (r.type !== "æµå±€") {
            // å‹å ´ (å‡ºè¡ æˆ– è‡ªæ‘¸ æˆ– åŒ…è‡ªæ‘¸)
            if (r.winner && stats[r.winner]) {
                stats[r.winner].wins++;
                // è‡ªæ‘¸æ•¸
                if (r.type === "è‡ªæ‘¸" || r.type === "åŒ…è‡ªæ‘¸") {
                    stats[r.winner].zimos++;
                }
            }
            
            // å‡ºè¡æ•¸ (å‡ºè¡ æˆ– åŒ…è‡ªæ‘¸ çš„è¼¸å®¶)
            if (r.loser && (r.type === "å‡ºè¡" || r.type === "åŒ…è‡ªæ‘¸")) {
                if (stats[r.loser]) stats[r.loser].dealIns++;
            }
        }
    });

    return { stats, totalGames };
}

function updateUI() {
    const currentDealer = getDealer(gameIndex);
    document.getElementById("roundDisplay").innerHTML = 
        `${getRoundName(gameIndex)} <span class='dealer-badge'>èŠï¼š${currentDealer}</span>`;

    // --- 1. æ›´æ–°çµ±è¨ˆè¡¨ (å«å‹ç‡ç­‰) ---
    const { stats, totalGames } = calculateStats();
    
    let summaryHtml = `<table class="stats-table">
        <tr>
            <th>ç©å®¶</th>
            <th>ç¸½åˆ†</th>
            <th>å‹ç‡</th>
            <th>è‡ªæ‘¸ç‡</th>
            <th>å‡ºè¡ç‡</th>
        </tr>`;

    // ä¾åˆ†æ•¸æ’åº
    const sortedPlayers = [...players].sort((a, b) => total[b] - total[a]);
    
    sortedPlayers.forEach(p => {
        const val = total[p];
        const pStats = stats[p];
        const gameCount = totalGames > 0 ? totalGames : 1; // é¿å…é™¤ä»¥0
        
        const winRate = ((pStats.wins / gameCount) * 100).toFixed(1) + "%";
        const zimoRate = ((pStats.zimos / gameCount) * 100).toFixed(1) + "%";
        const dealInRate = ((pStats.dealIns / gameCount) * 100).toFixed(1) + "%";
        
        const colorClass = val >= 0 ? "positive" : "negative";
        
        summaryHtml += `<tr>
            <td><strong>${p}</strong></td>
            <td><span class="${colorClass}" style="font-size:18px">${val > 0 ? "+" : ""}${val}</span></td>
            <td>${winRate}</td>
            <td>${zimoRate}</td>
            <td>${dealInRate}</td>
        </tr>`;
    });
    summaryHtml += "</table>";
    
    // åº•éƒ¨åŠ ä¸€å€‹ç¸½å ´æ•¸
    summaryHtml += `<div style="text-align:right; font-size:12px; color:#888; margin-top:5px;">ç¸½å±€æ•¸: ${totalGames}</div>`;
    
    document.getElementById("summary").innerHTML = summaryHtml;

    // --- 2. æ›´æ–°ç´€éŒ„è¡¨ (å«æ™‚é–“) ---
    let logHtml = `<table class="log-table" id="logTable">
        <thead>
            <tr>
                <th>æ™‚é–“</th>
                <th>å±€æ•¸</th>
                <th>çµæœ</th>
                ${players.map(p => `<th>${p}</th>`).join('')}
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>`;
    
    records.forEach((r, i) => {
        const typeLabel = r.type === "å‡ºè¡" ? `<span style='color:red'>å‡ºè¡</span>` : 
                          r.type === "æµå±€" ? `<span style='color:gray'>æµå±€</span>` :
                          `<span style='color:green'>${r.type}</span>`;
        
        let detail = "";
        if (r.type === "æµå±€") detail = "éèŠ";
        else detail = `${r.fan}ç•ª ` + (r.nextAction==="é€£èŠ"?"<span style='color:orange'>(é€£)</span>":"");
        
        // é¡¯ç¤ºæ™‚é–“ï¼Œè‹¥èˆŠè³‡æ–™æ²’æœ‰æ™‚é–“å‰‡é¡¯ç¤º "-"
        const timeStr = r.timestamp || "-";

        logHtml += `<tr>
            <td style="font-size:12px; color:#666">${timeStr}</td>
            <td>${r.roundStr}<br><span style="font-size:12px;color:#888">èŠ:${r.dealer}</span></td>
            <td>${typeLabel}<br><span style="font-size:12px">${detail}</span></td>`;
            
        players.forEach(p => {
            const val = r.changes[p];
            let displayVal = val;
            let style = "";
            if (val > 0) { displayVal = "+" + val; style = "color:green; font-weight:bold;"; }
            else if (val < 0) { style = "color:red;"; }
            else { displayVal = "-"; style="color:#ccc;"; }
            
            if (p === r.winner) style += "background:#e8f5e9;";
            if (p === r.loser && (r.type==="å‡ºè¡" || r.type==="åŒ…è‡ªæ‘¸")) style += "background:#ffebee;";
            
            logHtml += `<td style="${style}">${displayVal}</td>`;
        });
        // PDF è¼¸å‡ºæ™‚æˆ‘å€‘é€šå¸¸æœƒéš±è—æ“ä½œæŒ‰éˆ•ï¼Œé€™è£¡é€é CSS é¡åˆ¥æ§åˆ¶ï¼Œæˆ–è€…åœ¨è¼¸å‡ºå‰è™•ç†
        logHtml += `<td data-html2canvas-ignore="true"><button style="padding:4px 8px; font-size:12px;" onclick="deleteRecord(${i})">æ’¤éŠ·</button></td></tr>`;
    });
    logHtml += "</tbody></table>";
    document.getElementById("log").innerHTML = logHtml;
}

function deleteRecord(index) {
    if(!confirm("ç¢ºå®šè¦æ’¤éŠ·é€™æ¢ç´€éŒ„å—ï¼Ÿåˆ†æ•¸èˆ‡å±€æ•¸å°‡æœƒå›æ»¾ã€‚")) return;
    const r = records[index];
    players.forEach(p => total[p] -= r.changes[p]);
    if (index === 0) {
        gameIndex = r.preGameIndex;
    } else {
        alert("æ³¨æ„ï¼šæ‚¨åˆªé™¤çš„ä¸æ˜¯æœ€æ–°ç´€éŒ„ï¼Œåˆ†æ•¸å·²é‚„åŸï¼Œä½†å±€æ•¸é †åºä¸æœƒæ”¹è®Šã€‚");
    }
    records.splice(index, 1);
    updateUI();
    saveData();
}

// PDF ä¸‹è¼‰åŠŸèƒ½
function downloadPDF() {
    const element = document.getElementById('logContent'); // é¸æ“‡è¦åˆ—å°çš„å€åŸŸ
    
    // ç‚ºäº† PDF ç¾è§€ï¼Œæˆ‘å€‘è‡¨æ™‚ç”¢ç”Ÿä¸€å€‹åŒ…å«ç¸½çµå’Œç´€éŒ„çš„å®¹å™¨
    const tempContainer = document.createElement('div');
    tempContainer.innerHTML = `
        <h2 style="text-align:center">ğŸ€„ ä¸‰éº»æˆ°ç¸¾ç´€éŒ„è¡¨</h2>
        <p style="text-align:center; color:#666">åŒ¯å‡ºæ™‚é–“: ${getCurrentTime()}</p>
        <hr>
        <h3>ğŸ“Š æœ€çµ‚çµæœ</h3>
        ${document.getElementById('summary').innerHTML}
        <br>
        <h3>ğŸ“œ è©³ç´°å°å±€</h3>
        ${document.getElementById('log').innerHTML}
    `;
    
    // è¨­å®š PDF é¸é …
    const opt = {
        margin:       10,
        filename:     `ä¸‰éº»æˆ°ç¸¾_${getCurrentTime().replace(/[\/ :]/g, '')}.pdf`,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    // åŸ·è¡Œè½‰æ›
    html2pdf().set(opt).from(tempContainer).save();
}

// åˆå§‹åŒ–
loadData();
updatePlayerNames();
</script>

</body>
</html>
